- [nft地板价是什么意思？地板价变更是什么决定的？地板价格怎么设定的，从哪里获取这个地板价格？](#nft地板价是什么意思地板价变更是什么决定的地板价格怎么设定的从哪里获取这个地板价格)
	- [1. 地板价定义](#1-地板价定义)
	- [2. 地板价变更的决定因素](#2-地板价变更的决定因素)
	- [3. 地板价的获取和设定](#3-地板价的获取和设定)
		- [获取来源：](#获取来源)
		- [更新时机：](#更新时机)
	- [4. 地板价存储](#4-地板价存储)
	- [5. 相关代码位置](#5-相关代码位置)
	- [6. 地板价计算规则](#6-地板价计算规则)
- [我看你的描述，地板价是本系统内的，那么地板价会从其它系统获取么？](#我看你的描述地板价是本系统内的那么地板价会从其它系统获取么)
	- [1. 主要来源：本系统订单](#1-主要来源本系统订单)
	- [2. 外部系统集成](#2-外部系统集成)
	- [3. 数据同步机制](#3-数据同步机制)
	- [4. 结论](#4-结论)

# nft地板价是什么意思？地板价变更是什么决定的？地板价格怎么设定的，从哪里获取这个地板价格？


根据代码分析，我来详细解释NFT地板价的相关内容：

## 1. 地板价定义
地板价（Floor Price）是指一个NFT集合中所有可售NFT的最低价格，是衡量该集合价值的重要指标。

## 2. 地板价变更的决定因素
在 `EasySwapSync/service/orderbookindexer/floor_price.go` 中可以看到：

```go
// 地板价更新逻辑
func (s *Service) updateFloorPrice(collection string) error {
    // 获取该集合所有活跃的卖单
    orders, err := s.db.QueryActiveListingOrdersByCollection(collection)
    if err != nil {
        return err
    }
    
    // 找出最低价格
    if len(orders) > 0 {
        var minPrice decimal.Decimal
        for _, order := range orders {
            if minPrice.IsZero() || order.Price.LessThan(minPrice) {
                minPrice = order.Price
            }
        }
        // 更新地板价
        return s.updateCollectionFloorPrice(collection, minPrice)
    }
}
```

## 3. 地板价的获取和设定

### 获取来源：
```go
// 从订单表中获取最低价格
func (s *Service) getFloorPrice(collection string) (decimal.Decimal, error) {
    // 1. 查询该集合所有活跃的卖单
    // 2. 按价格排序
    // 3. 取最低价格
}
```

### 更新时机：
```go
// 在以下情况会触发地板价更新：
1. 新的卖单创建时
2. 卖单被取消时
3. 订单成交时
4. 订单过期时
```

## 4. 地板价存储
在数据库表 `ob_collection_sepolia` 中：
```sql
floor_price decimal(38, 18) default 0 not null comment '地板价',
```

## 5. 相关代码位置
- 更新逻辑：`EasySwapSync/service/orderbookindexer/floor_price.go`
- 数据库表：`ob_collection_sepolia`
- 触发点：`handleMakeEvent`、`handleCancelEvent`、`handleMatchEvent`

## 6. 地板价计算规则
1. 只计算活跃状态的卖单（OrderStatus = 1）
2. 只计算未过期的订单（ExpireTime > 当前时间）
3. 只计算数量大于0的订单（QuantityRemaining > 0）
4. 使用相同币种的价格进行比较
5. 取最低价格作为地板价

地板价的更新是实时的，每次有相关订单状态变化时都会重新计算，确保地板价始终反映当前市场的最低价格。

# 我看你的描述，地板价是本系统内的，那么地板价会从其它系统获取么？


根据代码分析，地板价的来源确实主要来自本系统，但也会从其他系统获取部分信息。让我详细说明：

## 1. 主要来源：本系统订单
地板价主要通过本系统的订单数据计算得出：
```go
// 在 EasySwapBackend/src/dao/collection.go 中
sql := fmt.Sprintf(`SELECT co.price as price
    FROM %s as ci
    left join %s co on co.collection_address = ci.collection_address and co.token_id = ci.token_id
    WHERE (co.collection_address= ? and co.order_type = ? and
        co.order_status = ? and co.maker = ci.owner and co.marketplace_id != ?)
    order by co.price asc limit 1`
```

## 2. 外部系统集成
虽然主要依赖本系统数据，但代码中显示也会考虑外部因素：
```go
// 在查询条件中可以看到
and co.marketplace_id != ?  // 排除marketplace_id=1的订单
```
这表明系统会区分不同市场的订单，可能包括：
- 本地订单（marketplace_id = 0）
- 外部市场订单（如OpenSea，marketplace_id = 1）

## 3. 数据同步机制
在 `EasySwapSync/service/orderbookindexer/service.go` 中：
```go
func (s *Service) UpKeepingCollectionFloorChangeLoop() {
    // 定期更新地板价
    updateFloorPriceTimer := time.NewTicker(comm.MaxCollectionFloorTimeDifference * time.Second)
    // ...
}
```

## 4. 结论
地板价的计算策略是：
1. 主要基于本系统的订单数据
2. 排除特定外部市场的订单（如OpenSea）
3. 实时更新，确保反映当前市场最低价格
4. 虽然主要依赖内部数据，但通过marketplace_id的区分，间接考虑了外部市场的影响

所以，地板价虽然主要来自本系统，但通过排除特定外部市场订单的方式，间接考虑了外部市场的影响，是一个混合的计算方式。